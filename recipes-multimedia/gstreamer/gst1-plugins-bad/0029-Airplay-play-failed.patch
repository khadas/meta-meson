From 63ba28ad77d2f62629833a399996b5c6fe15d1f9 Mon Sep 17 00:00:00 2001
From: Runfeng Xiao <runfeng.xiao@amlogic.com>
Date: Mon, 19 Dec 2022 18:43:50 +0800
Subject: [PATCH 18/30] Airplay play failed.

Change-Id: I4b4da818c34a3603a2abaf66d7a1b48963eec408
---
 gst/mpegtsdemux/tsdemux.c | 29 ++++++++++++++++++++++-------
 gst/mpegtsdemux/tsdemux.h |  1 +
 2 files changed, 23 insertions(+), 7 deletions(-)

diff --git a/gst/mpegtsdemux/tsdemux.c b/gst/mpegtsdemux/tsdemux.c
index 8f6603f..bfeb3f3 100755
--- a/gst/mpegtsdemux/tsdemux.c
+++ b/gst/mpegtsdemux/tsdemux.c
@@ -296,6 +296,7 @@ enum
   PROP_EMIT_STATS,
   PROP_CHECK_PCR_ILLEGAL,
   PROP_PROTECT_PTS,
+  PROP_SWITCH_FILE_SRC,
   /* FILL ME */
 };
 
@@ -398,6 +399,11 @@ gst_ts_demux_class_init (GstTSDemuxClass * klass)
           "if cal pts error, protect pts", FALSE,
           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 
+  g_object_class_install_property (gobject_class, PROP_SWITCH_FILE_SRC,
+      g_param_spec_boolean ("switch-filesrc", "switch-filesrc",
+          "Local multimedia property flag.", FALSE,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+
   element_class = GST_ELEMENT_CLASS (klass);
   gst_element_class_add_pad_template (element_class,
       gst_static_pad_template_get (&video_template));
@@ -474,6 +480,7 @@ gst_ts_demux_init (GstTSDemux * demux)
   demux->requested_program_number = -1;
   demux->program_number = -1;
   demux->no_check_pcr_count = 0;
+  demux->switch_file_src = FALSE;
   gst_ts_demux_reset (base);
 }
 
@@ -499,6 +506,10 @@ gst_ts_demux_set_property (GObject * object, guint prop_id,
     case PROP_PROTECT_PTS:
       MPEG_TS_BASE_PACKETIZER (demux)->protect_pts = g_value_get_boolean (value);
       break;
+    case PROP_SWITCH_FILE_SRC:
+      demux->switch_file_src = g_value_get_boolean(value);
+      GST_WARNING("switch_filesrc:%d", demux->switch_file_src);
+      break;
     default:
       G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
   }
@@ -3152,13 +3163,17 @@ gst_ts_demux_push_pending_data (GstTSDemux * demux, TSDemuxStream * stream,
       GST_TIME_FORMAT, (buffer_list ? "list" : ""), GST_TIME_ARGS (stream->pts),
       GST_TIME_ARGS (stream->dts));
 
-   GstClockTime dur;
-   gst_ts_demux_get_duration (demux, &dur);
-   if( dur<stream->pts )
-   {
-      GST_ELEMENT_ERROR(demux, RESOURCE, FAILED, ("GStreamer encountered a general resource error"), ("GStreamer encountered a general resource error"));
-      res = GST_FLOW_ERROR;
-      goto beach;
+  if( demux->switch_file_src )
+  {
+      GstClockTime dur;
+      gst_ts_demux_get_duration (demux, &dur);
+      if( dur < stream->pts )
+      {
+         GST_ELEMENT_ERROR(demux, RESOURCE, FAILED, ("Duration is shorter than the start time resource error"),
+             ("Duration is shorter than the start time resource error"));
+         res = GST_FLOW_ERROR;
+         goto beach;
+      }
    }
 
   if (GST_CLOCK_TIME_IS_VALID (stream->dts))
diff --git a/gst/mpegtsdemux/tsdemux.h b/gst/mpegtsdemux/tsdemux.h
index 378d001..acf7078 100644
--- a/gst/mpegtsdemux/tsdemux.h
+++ b/gst/mpegtsdemux/tsdemux.h
@@ -70,6 +70,7 @@ struct _GstTSDemux
 
   gboolean have_group_id;
   guint group_id;
+  gboolean switch_file_src;
 
   /* the following vars must be protected with the OBJECT_LOCK as they can be
    * accessed from the application thread and the streaming thread */
-- 
2.34.1

