From d3abf3bf8664a63ba1c4ab9c31a97fdba76899a6 Mon Sep 17 00:00:00 2001
From: "Wayne.zhang" <Wayne.zhang@amlogic.com>
Date: Wed, 30 Jun 2021 11:33:33 +0800
Subject: [PATCH 06/30] =?UTF-8?q?=E3=80=90=E8=A7=A3=E5=86=B3=E9=97=AE?=
 =?UTF-8?q?=E9=A2=98=E3=80=91=EF=BC=9A=E4=B8=AA=E5=88=AB=E7=89=87=E6=BA=90?=
 =?UTF-8?q?seek=E6=97=B6=E9=97=B4=E8=B6=85=E9=A2=9D=E9=97=AE=E9=A2=98patch?=
 =?UTF-8?q?=20=E3=80=90=E6=B5=8B=E8=AF=95=E6=B3=A8=E6=84=8F=E3=80=91?=
 =?UTF-8?q?=EF=BC=9A=E6=98=AF=E5=90=A6=E6=9C=89=E5=85=B6=E5=AE=83=E9=97=AE?=
 =?UTF-8?q?=E9=A2=98=E5=BB=B6=E4=BC=B8=20=E3=80=90=E6=B5=8B=E8=AF=95?=
 =?UTF-8?q?=E7=BB=93=E6=9E=9C=E3=80=91=EF=BC=9Ay=20=E3=80=90=E9=97=AE?=
 =?UTF-8?q?=E9=A2=98=E5=8D=95=E5=8F=B7=E3=80=91=EF=BC=9AWXLTV-15204=20?=
 =?UTF-8?q?=E3=80=90=E6=93=8D=E4=BD=9C=E7=B1=BB=E5=9E=8B=E3=80=91=EF=BC=9A?=
 =?UTF-8?q?mod=20=E3=80=90=E9=87=8D=E8=A6=81=E7=A8=8B=E5=BA=A6=E3=80=91?=
 =?UTF-8?q?=EF=BC=9A=E9=87=8D=E8=A6=81=20=E3=80=90=E5=BD=B1=E5=93=8D?=
 =?UTF-8?q?=E4=BA=A7=E5=93=81=E3=80=91=EF=BC=9At921d?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Change-Id: I31550de71150469c6a06e2aea60a75bd2f565221
---
 gst/mpegdemux/gstmpegdemux.c | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/gst/mpegdemux/gstmpegdemux.c b/gst/mpegdemux/gstmpegdemux.c
index cbcfb79..382f6e9 100644
--- a/gst/mpegdemux/gstmpegdemux.c
+++ b/gst/mpegdemux/gstmpegdemux.c
@@ -179,6 +179,8 @@ static void gst_segment_set_position (GstSegment * segment, GstFormat format,
 static void gst_segment_set_duration (GstSegment * segment, GstFormat format,
     guint64 duration);
 
+static gboolean g_notSeekStatus = TRUE;
+
 /*static guint gst_ps_demux_signals[LAST_SIGNAL] = { 0 };*/
 
 GType
@@ -1359,6 +1361,8 @@ gst_ps_demux_src_event (GstPad * pad, GstObject * parent, GstEvent * event)
 
   switch (GST_EVENT_TYPE (event)) {
     case GST_EVENT_SEEK:
+      if(!g_notSeekStatus)  return res;
+
       if (demux->random_access) {
         res = gst_ps_demux_handle_seek_pull (demux, event);
       } else {
@@ -1485,6 +1489,7 @@ gst_ps_demux_src_query (GstPad * pad, GstObject * parent, GstQuery * query)
     }
     case GST_QUERY_SEEKING:{
       GstFormat fmt;
+      if(!g_notSeekStatus)  goto not_supported;
 
       gst_query_parse_seeking (query, &fmt, NULL, NULL, NULL);
 
@@ -2221,6 +2226,15 @@ gst_ps_demux_data_cb (GstPESFilter * filter, gboolean first,
   datalen = map.size;
   start_code = filter->start_code;
   id = filter->id;
+
+  if( ((demux->src_segment.position) > (demux->src_segment.duration+3000000000) || 
+    (MPEGTIME_TO_GSTTIME (demux->current_scr) > (demux->src_segment.duration+3000000000)) ) 
+    && g_notSeekStatus)
+  {
+    g_notSeekStatus = FALSE;
+    GST_ELEMENT_WARNING (demux, RESOURCE, SEEK, ("format not support"), ("vob(VOB) format not support"));
+  }
+
   if (first) {
     /* find the stream type */
     stream_type = demux->psm[id];
@@ -3202,6 +3216,7 @@ gst_ps_demux_change_state (GstElement * element, GstStateChange transition)
       gst_ps_demux_reset (demux);
       break;
     case GST_STATE_CHANGE_READY_TO_NULL:
+      g_notSeekStatus = TRUE;
       gst_pes_filter_uninit (&demux->filter);
       break;
     default:
-- 
2.34.1

