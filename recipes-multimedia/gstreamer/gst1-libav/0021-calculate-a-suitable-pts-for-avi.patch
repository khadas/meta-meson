From 0f5208fbdd0ebb55a8f1874380cb407976eeb6ba Mon Sep 17 00:00:00 2001
From: "fei.deng" <fei.deng@amlogic.com>
Date: Sat, 3 Jun 2023 02:48:36 +0000
Subject: [PATCH] calculate a suitable pts for avi

Change-Id: I9fec1386aa297c0764d8387a3e846de4f7065c04
---
 ext/libav/gstavdemux.c | 36 ++++++++++++++++++++++++++++++------
 1 file changed, 30 insertions(+), 6 deletions(-)

diff --git a/ext/libav/gstavdemux.c b/ext/libav/gstavdemux.c
index 6c4dcbc..07d1303 100644
--- a/ext/libav/gstavdemux.c
+++ b/ext/libav/gstavdemux.c
@@ -460,6 +460,8 @@ gst_ffmpegdemux_do_seek (GstFFMpegDemux * demux, GstSegment * segment)
 
   /* get the stream for seeking */
   stream = demux->context->streams[index];
+  /*set last ts to time none,if seeking*/
+  demux->streams[stream->index]->last_ts = GST_CLOCK_TIME_NONE;
   /* initial seek position */
   target = segment->position + demux->start_time;
   /* convert target to ffmpeg time */
@@ -1541,15 +1543,37 @@ gst_ffmpegdemux_loop (GstFFMpegDemux * demux)
   }
 
   //calculate a new pts when timestamp is no value but duration is available
-  if ((!strcmp(demux->context->iformat->name, "avi")) && timestamp == GST_CLOCK_TIME_NONE && duration != GST_CLOCK_TIME_NONE) {
-    if (stream->last_ts == GST_CLOCK_TIME_NONE) {
-      stream->last_ts = 0;
+  if ((!strcmp(demux->context->iformat->name, "avi")) && timestamp == GST_CLOCK_TIME_NONE) {
+    GstClockTime dts = gst_ffmpeg_time_ff_to_gst (pkt.dts, avstream->time_base);
+    //set dts as pts
+    if (GST_CLOCK_TIME_IS_VALID (dts)) {
+      timestamp = dts;
+      stream->last_ts = timestamp;
+      GST_DEBUG_OBJECT (demux,"set dts as pts:%" GST_TIME_FORMAT,GST_TIME_ARGS (timestamp));
+    } else {
+      if (stream->last_ts != GST_CLOCK_TIME_NONE && duration != GST_CLOCK_TIME_NONE) {
+        timestamp = stream->last_ts  + duration;
+        stream->last_ts = timestamp;
+        GST_DEBUG_OBJECT (demux,"calculate pts with last pts:%" GST_TIME_FORMAT,GST_TIME_ARGS (timestamp));
+      } else {
+        #if 0
+        /*we should find a suitable stream, set the stream last pts to this stream's timestamp*/
+        for (int i = 0; i < MAX_STREAMS; i++) {
+          GstFFStream *suitStream = demux->streams[i];
+          if (suitStream && suitStream->avstream->index != avstream->index &&
+            !suitStream->unknown &&
+              suitStream->last_ts != GST_CLOCK_TIME_NONE) {
+            stream->last_ts = suitStream->last_ts;
+            GST_WARNING_OBJECT (demux,"reset last_ts to suitable pts:%" GST_TIME_FORMAT,GST_TIME_ARGS (stream->last_ts));
+            break;
+          }
+        }
+        #endif
+        GST_WARNING_OBJECT (demux,"sorry,we can't calculate a suitable pts");
+      }
     }
-    timestamp = stream->last_ts  + duration;
-    stream->last_ts = timestamp;
   }
 
-
   GST_DEBUG_OBJECT (demux,
       "pkt pts:%" GST_TIME_FORMAT
       " / size:%d / stream_index:%d / flags:%d / duration:%" GST_TIME_FORMAT
-- 
2.25.1

