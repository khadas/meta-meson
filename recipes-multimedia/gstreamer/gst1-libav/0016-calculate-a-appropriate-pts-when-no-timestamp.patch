From 6e8a83e5ea390668cafba728d476eb68d97175ee Mon Sep 17 00:00:00 2001
From: "fei.deng" <fei.deng@amlogic.com>
Date: Tue, 14 Jun 2022 15:58:05 +0800
Subject: [PATCH] calculate a appropriate pts when no timestamp

Change-Id: I43a3d9cf25dd82c537232a24e17b48a4bc23cc72
---
 ext/libav/gstavdemux.c | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/ext/libav/gstavdemux.c b/ext/libav/gstavdemux.c
index ac17a4a..9a2e33b 100644
--- a/ext/libav/gstavdemux.c
+++ b/ext/libav/gstavdemux.c
@@ -1542,6 +1542,15 @@ gst_ffmpegdemux_loop (GstFFMpegDemux * demux)
     duration = GST_CLOCK_TIME_NONE;
   }
 
+  //calculate a new pts when timestamp is no value but duration is available
+  if ((!strcmp(demux->context->iformat->name, "avi")) && timestamp == GST_CLOCK_TIME_NONE && duration != GST_CLOCK_TIME_NONE) {
+    if (stream->last_ts == GST_CLOCK_TIME_NONE) {
+      stream->last_ts = 0;
+    }
+    timestamp = stream->last_ts  + duration;
+    stream->last_ts = timestamp;
+  }
+
 
   GST_DEBUG_OBJECT (demux,
       "pkt pts:%" GST_TIME_FORMAT
@@ -1703,8 +1712,9 @@ read_failed:
     if (demux->flushing)
       ret = GST_FLOW_FLUSHING;
     else if (gst_ffmpegdemux_has_outputted (demux)
-        || gst_ffmpegdemux_is_eos (demux)) {
+        || gst_ffmpegdemux_is_eos (demux) || res == AVERROR_EOF) {
       GST_DEBUG_OBJECT (demux, "We are EOS");
+      res = 0;
       ret = GST_FLOW_EOS;
     } else
       ret = GST_FLOW_ERROR;
-- 
2.25.1

